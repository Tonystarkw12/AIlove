"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o="http://localhost:3000",t={__name:"edit",setup(t){let i="";const n=e.reactive({user_id:"",nickname:"",email:"",gender:"",birth_date:"",height_cm:null,weight_kg:null,occupation:"",salary_range:"",orientation:"",bio:"",avatar_url:"",photos:[]}),l=e.ref([{value:"男",label:"男"},{value:"女",label:"女"},{value:"其他",label:"其他"}]),r=e.computed((()=>l.value.findIndex((e=>e.value===n.gender)))),s=e.ref([{value:"5千以下",label:"5千以下"},{value:"5k-10k",label:"5千-1万"},{value:"10k-20k",label:"1万-2万"},{value:"20k-30k",label:"2万-3万"},{value:"30k-50k",label:"3万-5万"},{value:"50k+",label:"5万以上"}]),d=e.computed((()=>s.value.findIndex((e=>e.value===n.salary_range)))),u=e.ref([{value:"异性恋",label:"异性恋"},{value:"同性恋",label:"同性恋"},{value:"双性恋",label:"双性恋"},{value:"无性恋",label:"无性恋"},{value:"泛性恋",label:"泛性恋"},{value:"其他",label:"其他/不确定"}]),h=e.computed((()=>u.value.findIndex((e=>e.value===n.orientation)))),c=async(a,t,n,l={})=>i?e.index.request({url:`${o}${a}`,method:t,data:n,header:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,...l}}):(e.index.showToast({title:"用户未登录",icon:"none"}),Promise.reject("No auth token")),v=async(a,t,n,l={})=>i?e.index.uploadFile({url:`${o}${a}`,filePath:t,name:n,formData:l,header:{Authorization:`Bearer ${i}`}}):(e.index.showToast({title:"用户未登录",icon:"none"}),Promise.reject("No auth token"));e.onMounted((async()=>{var a,o;if(i=e.index.getStorageSync("token"),!i)return e.index.showToast({title:"请先登录",icon:"none"}),void e.index.navigateTo({url:"/pages/login/login"});e.index.showLoading({title:"加载中..."});try{const t=await c("/users/me/profile","GET");if(200===t.statusCode){const e=t.data;Object.keys(n).forEach((a=>{void 0!==e[a]&&(n[a]=e[a])})),e.photos&&Array.isArray(e.photos)?n.photos=e.photos.map((a=>({...a,is_avatar:a.url===e.avatar_url||a.is_avatar}))):n.photos=[],n.avatar_url=e.avatar_url||""}else e.index.showToast({title:`加载资料失败: ${(null==(o=null==(a=t.data)?void 0:a.error)?void 0:o.message)||t.statusCode}`,icon:"none"})}catch(t){console.error("Fetch profile error:",t),e.index.showToast({title:"网络错误，加载资料失败",icon:"none"})}finally{e.index.hideLoading()}}));const p=(e,a)=>{var o,t,i;const r=parseInt(e.detail.value);"gender"===a?n.gender=(null==(o=l.value[r])?void 0:o.value)||"":"salary_range"===a?n.salary_range=(null==(t=s.value[r])?void 0:t.value)||"":"orientation"===a&&(n.orientation=(null==(i=u.value[r])?void 0:i.value)||"")},_=e=>{n.birth_date=e.detail.value},g=()=>{e.index.chooseImage({count:6-n.photos.length,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{var o;e.index.showLoading({title:"上传中..."});for(const i of a.tempFilePaths)try{const a=await v("/users/me/photos",i,"photos");if(201===a.statusCode){const e=JSON.parse(a.data);if(e.uploadedPhotos&&e.uploadedPhotos.length>0){const a=e.uploadedPhotos[0];n.photos.push({...a,is_avatar:!1})}}else{const t=JSON.parse(a.data);e.index.showToast({title:`上传失败: ${(null==(o=null==t?void 0:t.error)?void 0:o.message)||a.statusCode}`,icon:"none"})}}catch(t){console.error("Upload error:",t),e.index.showToast({title:"上传图片失败",icon:"none"})}e.index.hideLoading()}})},m=async()=>{var a,o;if(!n.nickname)return void e.index.showToast({title:"请输入昵称",icon:"none"});if(0===n.photos.length)return void e.index.showToast({title:"请至少上传一张照片",icon:"none"});e.index.showLoading({title:"保存中..."});const t={nickname:n.nickname,gender:n.gender,birth_date:n.birth_date,height_cm:n.height_cm?Number(n.height_cm):null,weight_kg:n.weight_kg?Number(n.weight_kg):null,occupation:n.occupation,salary_range:n.salary_range,orientation:n.orientation,bio:n.bio};Object.keys(t).forEach((e=>{}));try{const i=await c("/users/me/profile","PUT",t);200===i.statusCode?(e.index.showToast({title:"资料保存成功",icon:"success",duration:1500}),i.data.updatedProfile&&(Object.assign(n,i.data.updatedProfile),i.data.updatedProfile.photos&&Array.isArray(i.data.updatedProfile.photos)?n.photos=i.data.updatedProfile.photos.map((e=>({...e,is_avatar:e.url===i.data.updatedProfile.avatar_url||e.is_avatar}))):n.photos=[],n.avatar_url=i.data.updatedProfile.avatar_url||""),setTimeout((()=>{e.index.navigateBack()}),1500)):e.index.showToast({title:`保存失败: ${(null==(o=null==(a=i.data)?void 0:a.error)?void 0:o.message)||i.statusCode}`,icon:"none"})}catch(i){console.error("Save profile error:",i),e.index.showToast({title:"保存资料失败",icon:"none"})}finally{e.index.hideLoading()}};return(t,i)=>{var v,x,f;return e.e({a:n.nickname,b:e.o((e=>n.nickname=e.detail.value)),c:e.t((null==(v=l.value[r.value])?void 0:v.label)||"请选择性别"),d:a._imports_0$1,e:e.o((e=>p(e,"gender"))),f:r.value,g:l.value,h:e.t(n.birth_date||"请选择出生日期"),i:a._imports_0$1,j:n.birth_date,k:e.o(_),l:n.height_cm,m:e.o(e.m((e=>n.height_cm=e.detail.value),{number:!0})),n:n.weight_kg,o:e.o(e.m((e=>n.weight_kg=e.detail.value),{number:!0})),p:n.occupation,q:e.o((e=>n.occupation=e.detail.value)),r:e.t((null==(x=s.value[d.value])?void 0:x.label)||"请选择月薪范围"),s:a._imports_0$1,t:e.o((e=>p(e,"salary_range"))),v:d.value,w:s.value,x:e.t((null==(f=u.value[h.value])?void 0:f.label)||"请选择性取向"),y:a._imports_0$1,z:e.o((e=>p(e,"orientation"))),A:h.value,B:u.value,C:n.bio,D:e.o((e=>n.bio=e.detail.value)),E:e.f(n.photos,((a,t,i)=>e.e({a:a.url.startsWith("http")||a.url.startsWith("/")?a.url:o+a.url,b:e.o((a=>(a=>{const t=n.photos.map((e=>e.url.startsWith("http")||e.url.startsWith("/")?e.url:o+e.url));e.index.previewImage({urls:t,current:a})})(t)),a.photo_id||t),c:a.is_avatar?1:"",d:a.is_avatar},(a.is_avatar,{}),{e:e.o((o=>(async(a,o)=>{a.photo_id?e.index.showModal({title:"确认",content:"确定要删除这张照片吗？",success:async t=>{var i,l;if(t.confirm){e.index.showLoading({title:"删除中..."});try{const t=await c(`/users/me/photos/${a.photo_id}`,"DELETE");200===t.statusCode?(n.photos.splice(o,1),a.is_avatar&&(n.avatar_url=""),e.index.showToast({title:"照片已删除",icon:"success"})):e.index.showToast({title:`删除失败: ${(null==(l=null==(i=t.data)?void 0:i.error)?void 0:l.message)||t.statusCode}`,icon:"none"})}catch(r){console.error("Delete photo error:",r),e.index.showToast({title:"删除照片失败",icon:"none"})}finally{e.index.hideLoading()}}}}):n.photos.splice(o,1)})(a,t)),a.photo_id||t),f:!a.is_avatar&&a.photo_id},!a.is_avatar&&a.photo_id?{g:e.o((o=>(async a=>{var o,t;if(a.photo_id){e.index.showLoading({title:"设置中..."});try{const i=await c("/users/me/avatar","PUT",{photoId:a.photo_id});200===i.statusCode?(n.avatar_url=i.data.avatarUrl,n.photos.forEach((e=>{e.is_avatar=e.photo_id===a.photo_id})),e.index.showToast({title:"头像设置成功",icon:"success"})):e.index.showToast({title:`设置头像失败: ${(null==(t=null==(o=i.data)?void 0:o.error)?void 0:t.message)||i.statusCode}`,icon:"none"})}catch(i){console.error("Set avatar error:",i),e.index.showToast({title:"设置头像失败",icon:"none"})}finally{e.index.hideLoading()}}else e.index.showToast({title:"照片尚未上传",icon:"none"})})(a)),a.photo_id||t)}:{},{h:a.photo_id||t}))),F:n.photos.length<6},n.photos.length<6?{G:e.o(g)}:{},{H:e.t(6),I:e.o(m)})}}},i=e._export_sfc(t,[["__scopeId","data-v-d901280e"]]);wx.createPage(i);
